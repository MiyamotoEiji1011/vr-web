<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkyWay P2P Room | Publish / Subscribe + WebXR</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header class="topbar">
      <div class="brand">
        <div class="logo">☁️</div>
        <div>
          <div class="title">SkyWay P2P Room</div>
          <div class="subtitle">Publish / Subscribe + WebXR (Quest 2)</div>
        </div>
      </div>

      <div class="status">
        <span class="pill pill--off" id="conn-pill">未接続</span>
        <span class="muted">ID:</span> <span class="mono" id="my-id">-</span>
        <button id="toggle-vr" class="btn">VRモード</button>
      </div>
    </header>

    <main class="container" id="ui-root">
      <section class="card">
        <h2 class="card-title">接続設定</h2>

        <div class="grid">
          <label class="field">
            <span class="label">Room name</span>
            <input id="room-name" type="text" placeholder="例: demo-room" />
          </label>

          <div class="field">
            <span class="label">モード</span>
            <div class="segmented" role="tablist" aria-label="mode">
              <label class="seg-item">
                <input type="radio" name="mode" value="both" checked />
                <span>両方</span>
              </label>
              <label class="seg-item">
                <input type="radio" name="mode" value="publish" />
                <span>Publishのみ</span>
              </label>
              <label class="seg-item">
                <input type="radio" name="mode" value="subscribe" />
                <span>Subscribeのみ</span>
              </label>
            </div>
          </div>

          <div class="field">
            <span class="label">Publish設定（Publishのみ / 両方で有効）</span>
            <div class="toggles">
              <label class="toggle">
                <input id="pub-video" type="checkbox" checked />
                <span>映像をPublish</span>
              </label>
              <label class="toggle">
                <input id="pub-audio" type="checkbox" checked />
                <span>音声をPublish</span>
              </label>
            </div>
            <div class="quality">
              <label class="field">
                <span class="label">解像度</span>
                <select id="video-res">
                  <option value="qvga">320×240</option>
                  <option value="vga">640×480</option>
                  <option value="hd" selected>1280×720</option>
                  <option value="fhd">1920×1080</option>
                </select>
              </label>

              <label class="field">
                <span class="label">FPS</span>
                <select id="video-fps">
                  <option value="15">15</option>
                  <option value="24">24</option>
                  <option value="30" selected>30</option>
                  <option value="60">60</option>
                </select>
              </label>

              <label class="toggle">
                <input id="video-hq" type="checkbox" />
                <span>高画質優先（帯域が足りないとカクつく）</span>
              </label>
            </div>

            <div class="hint" id="pub-hint">※ モードが Subscribeのみ の場合は無効になります</div>
          </div>

          <div class="field">
            <span class="label">VRデバッグモード</span>
            <div class="toggles">
              <label class="toggle">
                <input id="vr-debug" type="checkbox" />
                <span>VR空間でデバッグ情報を表示</span>
              </label>
            </div>
            <div class="hint">※ VRモードでヘッドセット/コントローラー情報とストリーム詳細を表示</div>
          </div>

          <div class="field actions">
            <button id="join" class="btn primary">Join</button>
            <button id="leave" class="btn" disabled>Leave</button>
          </div>
        </div>
      </section>

      <section class="two-col">
        <section class="card">
          <div class="card-head">
            <h2 class="card-title">Local</h2>
            <div class="small muted" id="local-note">Publishが有効なときだけ表示</div>
          </div>

          <div class="video-wrap">
            <video id="local-video" muted playsinline webkit-playsinline></video>
            <div class="video-overlay" id="local-overlay">Local Preview</div>
          </div>

          <div class="row">
            <button id="mute-av" class="btn" disabled>映像/音声 OFF</button>
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <h2 class="card-title">Remote</h2>
            <div class="small muted" id="remote-note">PublishされたStreamを自動で取得</div>
          </div>

          <div class="remote-tools">
            <label class="toggle">
              <input id="auto-subscribe" type="checkbox" checked />
              <span>自動Subscribe</span>
            </label>
            <button id="clear-remote" class="btn">Remote表示をクリア</button>
          </div>

          <div class="remote-grid" id="remote-media-area"></div>
        </section>
      </section>

      <section class="card">
        <div class="card-head">
          <h2 class="card-title">Publications</h2>
          <div class="small muted">手動Subscribe用ボタン（自動Subscribe OFFのとき便利）</div>
        </div>
        <div id="button-area" class="button-area"></div>
      </section>
    </main>

    <!-- VRテクスチャ用 video を置く（display:none禁止、画面外に置いて生かす） -->
    <div id="media-hub" class="media-hub"></div>

    <!-- =========================
         VR ROOT (A-Frame / WebXR)
         ========================= -->
    <div id="vr-root" class="vr-hidden">
      <a-scene
        id="vr-scene"
        background="color: #0b0f17"
        renderer="antialias: true; colorManagement: true"
        vr-mode-ui="enabled: true"
        embedded
      >
        <!-- assetsは使っても良いが、videoはmedia-hub側に置く（display:none事故回避） -->
        <a-assets id="vr-assets"></a-assets>

        <a-plane rotation="-90 0 0" width="50" height="50" color="#101827"></a-plane>

        <!-- Camera rig -->
        <a-entity id="camera-rig" position="0 1.6 0">
          <a-camera id="vr-camera" wasd-controls-enabled="false">
            <!-- ★頭に追従するHUDスクリーン群 -->
            <a-entity id="vr-screens" position="0 -0.2 -1.6" rotation="-8 0 0"></a-entity>
            
            <!-- ★映像切り替えコントロール（スクリーンの下） -->
            <a-entity id="vr-stream-controls" position="0 -0.8 -1.6" rotation="-8 0 0" visible="false">
              <!-- 左ボタン -->
              <a-entity id="vr-prev-btn" class="vr-nav-btn" position="-0.4 0 0">
                <a-plane 
                  width="0.15" 
                  height="0.15" 
                  color="#7c3aed" 
                  opacity="0.9"
                  class="clickable">
                </a-plane>
                <a-text 
                  value="<" 
                  align="center" 
                  width="0.5"
                  color="#ffffff"
                  position="0 0 0.01">
                </a-text>
              </a-entity>
              
              <!-- ストリーム情報表示 -->
              <a-entity id="vr-stream-info" position="0 0 0">
                <a-plane 
                  width="0.6" 
                  height="0.15" 
                  color="#1e293b" 
                  opacity="0.9">
                </a-plane>
                <a-text 
                  id="vr-stream-counter"
                  value="1 / 1" 
                  align="center" 
                  width="0.5"
                  color="#22c55e"
                  position="0 0.03 0.01">
                </a-text>
                <a-text 
                  id="vr-stream-name"
                  value="Stream ID" 
                  align="center" 
                  width="0.4"
                  color="#9ca3af"
                  position="0 -0.03 0.01">
                </a-text>
              </a-entity>
              
              <!-- 右ボタン -->
              <a-entity id="vr-next-btn" class="vr-nav-btn" position="0.4 0 0">
                <a-plane 
                  width="0.15" 
                  height="0.15" 
                  color="#7c3aed" 
                  opacity="0.9"
                  class="clickable">
                </a-plane>
                <a-text 
                  value=">" 
                  align="center" 
                  width="0.5"
                  color="#ffffff"
                  position="0 0 0.01">
                </a-text>
              </a-entity>
            </a-entity>
            
            <!-- ★デバッグパネル（右側に配置） -->
            <a-entity id="vr-debug-panel" position="1.5 -0.15 -1.0" rotation="0 -20 0" visible="false">
              <!-- 背景パネル -->
              <a-plane 
                width="0.8" 
                height="1.2" 
                color="#0f172a" 
                opacity="0.95"
                position="0 0 -0.01">
                <a-plane 
                  width="0.78" 
                  height="1.18" 
                  color="#1e293b" 
                  opacity="0.8"
                  position="0 0 0.001">
                </a-plane>
              </a-plane>
              
              <!-- タイトル -->
              <a-text 
                id="debug-title"
                value="DEBUG INFO" 
                align="center" 
                width="0.7"
                color="#7c3aed"
                position="0 0.55 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              
              <!-- ヘッドセット情報 -->
              <a-text 
                id="debug-headset-title"
                value="[HEADSET]" 
                align="left" 
                width="0.7"
                color="#22c55e"
                position="-0.35 0.42 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              <a-text 
                id="debug-headset-pos"
                value="Pos: 0.00, 0.00, 0.00" 
                align="left" 
                width="0.6"
                color="#e5e7eb"
                position="-0.35 0.32 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              <a-text 
                id="debug-headset-rot"
                value="Rot: 0.00, 0.00, 0.00" 
                align="left" 
                width="0.6"
                color="#e5e7eb"
                position="-0.35 0.22 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              
              <!-- 左コントローラー情報 -->
              <a-text 
                id="debug-left-title"
                value="[LEFT CONTROLLER]" 
                align="left" 
                width="0.7"
                color="#22c55e"
                position="-0.35 0.08 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              <a-text 
                id="debug-left-buttons"
                value="Btns: -" 
                align="left" 
                width="0.6"
                color="#e5e7eb"
                position="-0.35 -0.02 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              <a-text 
                id="debug-left-axes"
                value="Axes: -" 
                align="left" 
                width="0.6"
                color="#e5e7eb"
                position="-0.35 -0.12 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              
              <!-- 右コントローラー情報 -->
              <a-text 
                id="debug-right-title"
                value="[RIGHT CONTROLLER]" 
                align="left" 
                width="0.7"
                color="#22c55e"
                position="-0.35 -0.26 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              <a-text 
                id="debug-right-buttons"
                value="Btns: -" 
                align="left" 
                width="0.6"
                color="#e5e7eb"
                position="-0.35 -0.36 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              <a-text 
                id="debug-right-axes"
                value="Axes: -" 
                align="left" 
                width="0.6"
                color="#e5e7eb"
                position="-0.35 -0.46 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
              
              <!-- ストリーム情報 -->
              <a-text 
                id="debug-stream-title"
                value="[STREAMS]" 
                align="left" 
                width="0.7"
                color="#22c55e"
                position="-0.35 -0.60 0"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
              </a-text>
            </a-entity>
          </a-camera>
        </a-entity>

        <a-entity light="type: ambient; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>
      </a-scene>

      <div class="vr-hud">
        <div class="vr-hud-left">
          <div class="vr-hud-title">VR表示（WebXR）</div>
          <div class="vr-hud-sub">スクリーンは視点に追従。オフセット調整できます。</div>
        </div>

        <div class="vr-controls">
          <label>
            距離(Z)
            <input id="vr-z" type="range" min="0.5" max="3.0" step="0.1" value="0.6" />
            <span id="vr-zv">0.6</span>m
          </label>
          <label>
            高さ(Y)
            <input id="vr-y" type="range" min="-0.8" max="0.8" step="0.05" value="-0.2" />
            <span id="vr-yv">-0.2</span>
          </label>
          <label>
            横(X)
            <input id="vr-x" type="range" min="-1.0" max="1.0" step="0.05" value="0.9" />
            <span id="vr-xv">0.9</span>
          </label>
          <label>
            角度(Pitch)
            <input id="vr-pitch" type="range" min="-45" max="45" step="1" value="0" />
            <span id="vr-pv">0</span>°
          </label>
        </div>

        <div class="vr-hud-right">
          <button id="exit-vr" class="btn primary">UIに戻る</button>
        </div>
      </div>
    </div>

    <!-- SkyWay UMD（skyway_room が生える） -->
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room-latest.js"></script>

    <!-- A-Frame（WebXR対応） -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <script src="script.js"></script>
  </body>
</html>
