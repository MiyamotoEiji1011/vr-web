<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkyWay P2P Room | Publish / Subscribe + WebXR</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header class="topbar">
      <div class="brand">
        <div class="logo">☁️</div>
        <div>
          <div class="title">SkyWay P2P Room</div>
          <div class="subtitle">Publish / Subscribe + WebXR (Quest 2)</div>
        </div>
      </div>

      <div class="status">
        <span class="pill pill--off" id="conn-pill">未接続</span>
        <span class="muted">ID:</span> <span class="mono" id="my-id">-</span>
        <button id="toggle-vr" class="btn">VRモード</button>
      </div>
    </header>

    <main class="container" id="ui-root">
      <section class="card">
        <h2 class="card-title">接続設定</h2>

        <div class="grid">
          <label class="field">
            <span class="label">Room name</span>
            <input id="room-name" type="text" placeholder="例: demo-room" />
          </label>

          <div class="field">
            <span class="label">モード</span>
            <div class="segmented" role="tablist" aria-label="mode">
              <label class="seg-item">
                <input type="radio" name="mode" value="both" checked />
                <span>両方</span>
              </label>
              <label class="seg-item">
                <input type="radio" name="mode" value="publish" />
                <span>Publishのみ</span>
              </label>
              <label class="seg-item">
                <input type="radio" name="mode" value="subscribe" />
                <span>Subscribeのみ</span>
              </label>
            </div>
          </div>

          <div class="field">
            <span class="label">Publish設定（Publishのみ / 両方で有効）</span>
            <div class="toggles">
              <label class="toggle">
                <input id="pub-video" type="checkbox" checked />
                <span>映像をPublish</span>
              </label>
              <label class="toggle">
                <input id="pub-audio" type="checkbox" checked />
                <span>音声をPublish</span>
              </label>
            </div>
            <div class="hint" id="pub-hint">※ モードが Subscribeのみ の場合は無効になります</div>
          </div>

          <div class="field actions">
            <button id="join" class="btn primary">Join</button>
            <button id="leave" class="btn" disabled>Leave</button>
          </div>
        </div>
      </section>

      <section class="two-col">
        <section class="card">
          <div class="card-head">
            <h2 class="card-title">Local</h2>
            <div class="small muted" id="local-note">Publishが有効なときだけ表示</div>
          </div>

          <div class="video-wrap">
            <video id="local-video" muted playsinline webkit-playsinline></video>
            <div class="video-overlay" id="local-overlay">Local Preview</div>
          </div>

          <div class="row">
            <button id="mute-av" class="btn" disabled>映像/音声 OFF</button>
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <h2 class="card-title">Remote</h2>
            <div class="small muted" id="remote-note">PublishされたStreamを自動で取得</div>
          </div>

          <div class="remote-tools">
            <label class="toggle">
              <input id="auto-subscribe" type="checkbox" checked />
              <span>自動Subscribe</span>
            </label>
            <button id="clear-remote" class="btn">Remote表示をクリア</button>
          </div>

          <div class="remote-grid" id="remote-media-area"></div>
        </section>
      </section>

      <section class="card">
        <div class="card-head">
          <h2 class="card-title">Publications</h2>
          <div class="small muted">手動Subscribe用ボタン（自動Subscribe OFFのとき便利）</div>
        </div>
        <div id="button-area" class="button-area"></div>
      </section>
    </main>

    <!-- VRテクスチャ用 video を置く（display:none禁止、画面外に置いて生かす） -->
    <div id="media-hub" class="media-hub"></div>

    <!-- =========================
         VR ROOT (A-Frame / WebXR)
         ========================= -->
    <div id="vr-root" class="vr-hidden">
      <a-scene
        id="vr-scene"
        background="color: #0b0f17"
        renderer="antialias: true; colorManagement: true"
        vr-mode-ui="enabled: true"
        embedded
      >
        <!-- assetsは使っても良いが、videoはmedia-hub側に置く（display:none事故回避） -->
        <a-assets id="vr-assets"></a-assets>

        <a-plane rotation="-90 0 0" width="50" height="50" color="#101827"></a-plane>

        <!-- Camera rig -->
        <a-entity id="camera-rig" position="0 1.6 0">
          <a-camera id="vr-camera" wasd-controls-enabled="false">
            <!-- ★頭に追従するHUDスクリーン群 -->
            <a-entity id="vr-screens" position="0 -0.2 -1.6" rotation="-8 0 0"></a-entity>
          </a-camera>
        </a-entity>

        <a-entity light="type: ambient; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>
      </a-scene>

      <div class="vr-hud">
        <div class="vr-hud-left">
          <div class="vr-hud-title">VR表示（WebXR）</div>
          <div class="vr-hud-sub">スクリーンは視点に追従。オフセット調整できます。</div>
        </div>

        <div class="vr-controls">
          <label>
            距離(Z)
            <input id="vr-z" type="range" min="0.5" max="3.0" step="0.1" value="0.6" />
            <span id="vr-zv">0.6</span>m
          </label>
          <label>
            高さ(Y)
            <input id="vr-y" type="range" min="-0.8" max="0.8" step="0.05" value="-0.2" />
            <span id="vr-yv">-0.2</span>
          </label>
          <label>
            横(X)
            <input id="vr-x" type="range" min="-1.0" max="1.0" step="0.05" value="0.9" />
            <span id="vr-xv">0.9</span>
          </label>
          <label>
            角度(Pitch)
            <input id="vr-pitch" type="range" min="-45" max="45" step="1" value="0" />
            <span id="vr-pv">0</span>°
          </label>
        </div>

        <div class="vr-hud-right">
          <button id="exit-vr" class="btn primary">UIに戻る</button>
        </div>
      </div>
    </div>

    <!-- SkyWay UMD（skyway_room が生える） -->
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room-latest.js"></script>

    <!-- A-Frame（WebXR対応） -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <script src="script.js"></script>
  </body>
</html>
